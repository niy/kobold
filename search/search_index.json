{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Home","text":""},{"location":"#kobold","title":"Kobold","text":"<p>Kobold is a lightweight service that synchronizes a local eBook collection with Kobo eReaders. It automates file ingestion, enriches content with metadata, and serves books via the Kobo Sync API.</p>"},{"location":"#features","title":"Features","text":"<ul> <li>Lightweight: Minimal resource footprint. It has no UI, no external dependencies, and runs as a single process.</li> <li>Automatic Ingestion: Detects and processes new files immediately upon addition to watched directories.</li> <li>Metadata Enrichment: Retrieves high-resolution covers, series information, and ISBNs from Amazon and Goodreads.</li> <li>Automatic Conversion: Optionally converts <code>.epub</code> files to optimized <code>.kepub.epub</code> format.</li> </ul>"},{"location":"#getting-started","title":"Getting Started","text":"<p>To get started with Kobold, please refer to the following guides:</p> <ul> <li>Deployment: Instructions for running Kobold using Docker Compose or manually.</li> <li>Configuration: Comprehensive guide to environment variables and settings.</li> <li>Device Setup: Step-by-step instructions to configure your Kobo eReader.</li> <li>Architecture: Technical overview of the system's design and internals.</li> </ul>"},{"location":"architecture/","title":"Architecture","text":""},{"location":"architecture/#core-components","title":"Core Components","text":"<ol> <li>API Server (FastAPI): Handles HTTP requests from Kobo devices implementing the Kobo Sync Protocol.</li> <li>File Watcher: Monitors configured directories for changes using <code>watchfiles</code> (Rust-based file system events).</li> <li>Job Worker: Processes background tasks (hashing, ingestion, conversion) from a persistent SQLite queue.</li> <li>Scheduler:Executes periodic maintenance tasks, such as directory reconciliation.</li> </ol>"},{"location":"architecture/#data-flow","title":"Data Flow","text":""},{"location":"architecture/#1-ingestion","title":"1. Ingestion","text":"<ol> <li>Detection: The Watcher or Scanner identifies a new or modified file.</li> <li>Job Creation: An <code>INGEST</code> job is enqueued.</li> <li>Processing:<ul> <li>Hashing: The file is hashed using xxHash3-64 for identification.</li> <li>Deduplication: Checks against the database to prevent duplicate entries.</li> <li>Registration: A <code>Book</code> record is created or updated.</li> </ul> </li> </ol>"},{"location":"architecture/#2-metadata-enrichment","title":"2. Metadata Enrichment","text":"<ol> <li>Internal Extraction: Parses OPF (EPUB) or XMP (PDF) data for ISBN, Title, and Author.</li> <li>Amazon Scraping: Queries Amazon using the ISBN or Title/Author to retrieve high-resolution covers, descriptions, and series information.</li> <li>Goodreads Fallback: If Amazon retrieval fails, queries Goodreads.</li> <li>Filename Parsing: Falls back to parsing the filename format (e.g., \"Author - Title.epub\").</li> </ol>"},{"location":"architecture/#3-library-organization-optional","title":"3. Library Organization (Optional)","text":"<p>If enabled via <code>KB_ORGANIZE_LIBRARY</code>, books are automatically renamed and moved into a folder structure defined by <code>KB_ORGANIZE_TEMPLATE</code>. 1.  Trigger: Occurs after successful ingestion or metadata updates. 2.  Processing: <code>OrganizationJobService</code> calculates the target path based on metadata (e.g., <code>{author}/{series}/{title}</code>). 3.  Conflict Resolution:     *   Deduplication: If a file exists at the target with the exact same content hash, the source file is deleted.     *   Renaming: If content differs, a numeric suffix is appended (e.g., <code>Book_1.epub</code>). 4.  Recovery: Detects and fixes \"zombie states\" where the database path differs from the actual file location due to previous interruptions.</p>"},{"location":"architecture/#4-conversion-optional","title":"4. Conversion (Optional)","text":"<p>If configured, <code>.epub</code> files are converted to <code>.kepub.epub</code> using <code>kepubify</code>. This binary is automatically managed and invoked by the worker process. The converted file is stored alongside the original or (optionally) replaces the original.</p>"},{"location":"architecture/#5-synchronization","title":"5. Synchronization","text":"<p>When a device initiates a sync: 1.  Authentication: The device authenticates using the <code>KB_USER_TOKEN</code>. 2.  Entitlement Sync: The server compares the device's <code>SyncToken</code> with the library state. 3.  Delivery: New or updated books are sent to the device. Optimized KEPUB files are served if available.</p>"},{"location":"architecture/#data-persistence","title":"Data Persistence","text":"<ul> <li>Database: SQLite (<code>kobold.db</code>) stores metadata, file paths, and job states.</li> <li>Filesystem: User files are treated as read-only by default. However, if Library Organization is enabled, files will be moved and renamed. Only converted files or temporary artifacts are written to the storage volume otherwise.</li> </ul>"},{"location":"configuration/","title":"Configuration","text":"<p>Kobold is configured via environment variables.</p>"},{"location":"configuration/#core-settings","title":"Core Settings","text":"Variable Default Description <code>KB_USER_TOKEN</code> (none) Required: Secure token for API authentication. App will fail to start if missing. <code>KB_DATA_PATH</code> <code>./data</code> Directory for persistent application data (<code>kobold.db</code>). <code>KB_WATCH_DIRS</code> <code>/books</code> Comma-separated list of directories to monitor. <code>KB_WORKER_POLL_INTERVAL</code> <code>300.0</code> Interval in seconds between worker polls for new jobs (metadata, conversion). <code>KB_LOG_LEVEL</code> <code>INFO</code> Logging verbosity (<code>DEBUG</code>, <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>)."},{"location":"configuration/#metadata-providers","title":"Metadata Providers","text":"Variable Default Description <code>KB_AMAZON_DOMAIN</code> <code>com</code> Amazon region domain (e.g., <code>com</code>, <code>co.uk</code>, <code>de</code>, <code>jp</code>). <code>KB_AMAZON_COOKIE</code> (empty) Optional session cookie for authenticated requests to avoid rate limits."},{"location":"configuration/#feature-flags","title":"Feature Flags","text":"Variable Default Description <code>KB_CONVERT_EPUB</code> <code>True</code> Automatically convert <code>.epub</code> to <code>.kepub.epub</code>. <code>KB_DELETE_ORIGINAL_AFTER_CONVERSION</code> <code>False</code> Delete the original <code>.epub</code> file after successful conversion. <code>KB_EMBED_METADATA</code> <code>False</code> Write scraped metadata (cover, author, ISBN) back into the source file. <code>KB_FETCH_EXTERNAL_METADATA</code> <code>True</code> Query external sources (Amazon, Goodreads) for metadata. Set to <code>False</code> in test environments to avoid hitting external APIs."},{"location":"configuration/#library-organization","title":"Library Organization","text":"<p>Automatically organize your library into a structured folder hierarchy based on book metadata.</p> Variable Default Description <code>KB_ORGANIZE_LIBRARY</code> <code>False</code> Enable automatic file organization after metadata is fetched. files are moved from their import location. <code>KB_ORGANIZE_TEMPLATE</code> <code>{author}/{title}</code> Template pattern for folder structure."},{"location":"configuration/#template-variables","title":"Template Variables","text":"<p>Data is sourced from embedded metadata (EPUB) and external providers (Amazon, Goodreads).</p> Variable Description <code>{author}</code> Author name <code>{title}</code> Book title <code>{series}</code> Series name <code>{series_index}</code> Number in series <code>{language}</code> Language code <code>{genre}</code> Primary genre <code>{year}</code> Publication year"},{"location":"configuration/#template-examples","title":"Template Examples","text":"<pre><code># Simple author/title (default)\nKB_ORGANIZE_TEMPLATE={author}/{title}\n# \u2192 William Shakespeare/Romeo and Juliet.epub\n\n# Group by Series\nKB_ORGANIZE_TEMPLATE={author}/{series}/{series_index} - {title}\n# \u2192 William Shakespeare/The Folger Shakespeare Library/Romeo and Juliet.epub\n# \u2192 William Shakespeare/Hamlet.epub (no series)\n\n# Flat Author Directories\nKB_ORGANIZE_TEMPLATE={author} - {title}\n# \u2192 William Shakespeare - Romeo and Juliet.epub\n\n# Organize by Genre\nKB_ORGANIZE_TEMPLATE={genre}/{author}/{title}\n# \u2192 Plays/William Shakespeare/Romeo and Juliet.epub\n\n# Organize by Language and Year\nKB_ORGANIZE_TEMPLATE={language}/{year}/{author} - {title}\n# \u2192 en/1597/William Shakespeare - Romeo and Juliet.epub\n</code></pre>"},{"location":"configuration/#file-watcher","title":"File Watcher","text":"Variable Default Description <code>KB_WATCH_FORCE_POLLING</code> <code>False</code> Force polling mode. Required for some network shares (NFS/SMB). <code>KB_WATCH_POLL_DELAY_MS</code> <code>300</code> Polling interval in milliseconds (used only if polling is active)."},{"location":"deployment/","title":"Deployment","text":"<p>The official image is available at <code>ghcr.io/niy/kobold</code>.</p>"},{"location":"deployment/#deployment-guide","title":"Deployment Guide","text":""},{"location":"deployment/#docker-compose","title":"Docker Compose","text":""},{"location":"deployment/#1-generate-secure-token","title":"1. Generate Secure Token","text":"<p>Start by generating a strong random string. You can use any of the following commands:</p> <ul> <li>OpenSSL: <code>openssl rand -hex 16</code></li> <li>Python: <code>python3 -c \"import secrets; print(secrets.token_hex(16))\"</code></li> <li> <p>Password Manager: Use your password manager's built-in generator.</p> <p>Token Generator</p> <p> \u21bb </p> </li> </ul>"},{"location":"deployment/#2-create-configuration","title":"2. Create Configuration","text":"<p>Create a <code>docker-compose.yml</code> file.</p> <pre><code>services:\n    kobold:\n      image: ghcr.io/niy/kobold:latest\n      container_name: kobold\n      restart: unless-stopped\n      ports:\n        - \"8000:8000\"\n      volumes:\n        - ./data:/data\n        - /path/to/books:/books\n      environment:\n        - KB_USER_TOKEN=__YOUR_TOKEN_HERE__\n</code></pre>"},{"location":"deployment/#3-start-service","title":"3. Start Service","text":"<pre><code>docker compose up -d\n</code></pre>"},{"location":"deployment/#4-next-steps","title":"4. Next Steps","text":"<p>Once the service is running, configure your Kobo device to connect:</p> <ol> <li>See Device Setup to configure your Kobo eReader</li> <li>Review Configuration for additional options</li> </ol>"},{"location":"deployment/#troubleshooting","title":"Troubleshooting","text":""},{"location":"deployment/#permission-issues","title":"Permission Issues","text":"<p>If you encounter permission errors accessing the <code>/books</code> directory, ensure the container has read access. You can set the ownership to the current user:</p> <pre><code>chown -R $(id -u):$(id -g) ./books\n</code></pre>"},{"location":"deployment/#network-shares-nfssmb","title":"Network Shares (NFS/SMB)","text":"<p>If your <code>/books</code> directory is mounted from a network share (e.g., NAS), file watcher events might not propagate. In this case, you must enable polling mode.</p> <p>Update your <code>docker-compose.yml</code>:</p> <pre><code>environment:\n  - KB_WATCH_FORCE_POLLING=True\n  - KB_WATCH_POLL_DELAY_MS=500\n</code></pre>"},{"location":"deployment/#container-fails-to-start","title":"Container Fails to Start","text":"<p>Check the logs for error details:</p> <pre><code>docker compose logs -f\n</code></pre> <p>Common issues include:</p> <ul> <li>Port <code>8000</code> is already in use.</li> <li><code>KB_USER_TOKEN</code> is missing (it is required for startup).</li> </ul>"},{"location":"device_setup/","title":"Device Setup","text":"<p>To synchronize a Kobo eReader with Kobold, the device's configuration file must be modified to point to the Kobold server.</p>"},{"location":"device_setup/#configuration-steps","title":"Configuration Steps","text":"<ol> <li>Connect Device: Connect the Kobo eReader to the computer via USB and tap Connect on the device.</li> <li>Locate Config: Open the mounted Kobo drive and navigate to <code>.kobo/Kobo/Kobo eReader.conf</code>.<ul> <li>Note: The <code>.kobo</code> folder is hidden. Ensure hidden files are visible in the file explorer. On Mac, press <code>CMD + Shift + .</code> to show hidden files. On Windows, enable \"Show hidden files, folders, and drives\" in File Explorer settings.</li> </ul> </li> <li>Edit Config: Open <code>Kobo eReader.conf</code> in a text editor.</li> <li> <p>Update Endpoint: Locate the <code>[OneStoreServices]</code> section. Modify or add the <code>api_endpoint</code> key:</p> <pre><code>[OneStoreServices]\napi_endpoint=http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/api/kobo/&lt;KB_USER_TOKEN&gt;\n</code></pre> <p>Example: <pre><code>[OneStoreServices]\napi_endpoint=http://192.168.1.50:8000/api/kobo/my-secret-token\n</code></pre></p> <p>Example with reverse proxy: ```ini [OneStoreServices] api_endpoint=https://kobold.example.com/api/kobo/my-secret-token</p> </li> <li> <p>Save and Eject: Save the file and safely eject the device.</p> </li> <li>Sync: Tap the Sync icon on the Kobo device. New books should now appear.</li> </ol>"},{"location":"device_setup/#reverse-proxy-nginx","title":"Reverse Proxy (Nginx)","text":"<p>When running behind Nginx, ensure the following configuration is present in the <code>location</code> block to handle Kobo Sync Protocol headers:</p> <pre><code>location / {\n    proxy_pass http://localhost:8000;\n\n    # Headers required for sync\n    proxy_set_header Host $host;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Host $host;\n    proxy_set_header X-Forwarded-Proto $scheme;\n    proxy_set_header X-Forwarded-Port $server_port;\n\n    # Buffer settings for large headers\n    proxy_buffer_size 128k;\n    proxy_buffers 4 256k;\n    proxy_busy_buffers_size 256k;\n    large_client_header_buffers 8 32k;\n}\n</code></pre>"}]}